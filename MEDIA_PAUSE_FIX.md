# 媒体播放暂停功能修复说明

## 问题描述

在测试过程中发现媒体播放的暂停不稳定，主要问题包括：

1. **重复调用问题**：`pause_page()` 方法被调用了两次，导致重复的暂停操作
2. **媒体暂停不彻底**：某些网站的视频可能会在短暂暂停后继续播放
3. **页面可见性状态设置可能被覆盖**：某些网站可能会重新设置页面可见性状态

## 修复方案

### 1. 添加防重复调用机制

在 `WikiView` 类中添加了以下状态管理变量：

```python
self._is_paused = False  # 添加暂停状态标记
self._pause_lock = False  # 添加暂停锁，防止重复调用
```

### 2. 改进媒体停止脚本

增强了 `stop_media_playback()` 方法中的JavaScript代码：

- **更全面的媒体停止**：不仅暂停视频和音频，还设置音量为0、静音、重置播放时间
- **移除事件监听器**：移除可能导致自动播放的事件监听器
- **阻止新的媒体播放**：重写 `HTMLMediaElement.prototype.play` 方法，阻止新的媒体播放
- **iframe媒体处理**：更好地处理iframe中的媒体内容

### 3. 优化暂停逻辑

改进了 `pause_page()` 方法：

- **防重复调用检查**：在方法开始时检查是否已经在暂停中
- **状态管理**：使用 `_is_paused` 标记来跟踪暂停状态
- **更全面的页面状态设置**：不仅设置可见性，还设置页面交互性

### 4. 改进恢复逻辑

改进了 `resume_page()` 方法：

- **状态检查**：只有在页面处于暂停状态时才执行恢复操作
- **完整的状态恢复**：恢复页面可见性、交互性和媒体播放功能
- **原始方法恢复**：恢复被重写的 `play` 方法

### 5. 优化调用时机

修改了 `hideEvent()` 和 `show_chat_view()` 方法：

- **条件性暂停**：只有在当前显示Wiki视图时才执行暂停操作
- **避免不必要的调用**：减少重复的暂停调用

## 修复效果

### 解决的问题

1. ✅ **重复调用问题**：通过状态锁和条件检查，避免了重复的暂停操作
2. ✅ **媒体暂停不彻底**：通过更全面的JavaScript脚本，确保媒体完全停止
3. ✅ **页面状态被覆盖**：通过更强大的状态设置，防止被网站重新设置

### 新增功能

1. **状态跟踪**：可以准确知道页面是否处于暂停状态
2. **防重复机制**：避免重复调用导致的性能问题
3. **更稳定的媒体控制**：通过重写play方法，从根本上阻止新的媒体播放

## 测试方法

可以使用提供的测试脚本 `test_media_pause.py` 来验证修复效果：

```bash
python test_media_pause.py
```

测试内容包括：
- 加载YouTube页面
- 测试暂停功能
- 测试恢复功能
- 测试重复暂停调用

## 代码变更

主要修改的文件：`src/game_wiki_tooltip/unified_window.py`

修改的方法：
- `WikiView.__init__()` - 添加状态管理变量
- `WikiView.stop_media_playback()` - 增强媒体停止脚本
- `WikiView.pause_page()` - 添加防重复调用和状态管理
- `WikiView.resume_page()` - 改进恢复逻辑
- `WikiView.hideEvent()` - 优化调用时机
- `UnifiedAssistantWindow.show_chat_view()` - 优化调用时机

## 注意事项

1. **兼容性**：修复后的代码保持了与现有功能的兼容性
2. **性能**：通过防重复调用机制，避免了不必要的性能开销
3. **稳定性**：更全面的错误处理和状态管理，提高了代码的稳定性

## 日志输出

修复后的代码会输出更详细的日志信息，帮助调试：

- `🔄 WikiView: 暂停操作正在进行中，跳过重复调用`
- `🔇 WikiView: 已执行增强媒体停止脚本`
- `🔇 媒体播放已停止并阻止新的播放`
- `▶️ WikiView: 页面已恢复可见和交互状态` 